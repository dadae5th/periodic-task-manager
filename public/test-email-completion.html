<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이메일 완료 버튼 테스트</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            line-height: 1.6;
        }
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid #dee2e6; 
        }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            margin: 10px 5px; 
            background: #28a745; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
        }
        .btn-batch { background: #17a2b8; }
        .btn-debug { background: #dc3545; }
        .btn-tool { background: #6c757d; padding: 8px 16px; font-size: 14px; }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            margin: 10px 0; 
            word-break: break-all;
        }
        .info { 
            background: #d1ecf1; 
            border: 1px solid #bee5eb; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>📧 이메일 완료 버튼 자동 로그인 테스트</h1>
    
    <div class="info">
        <strong>테스트 목적:</strong> 메일에서 완료 버튼 클릭시 자동 로그인이 작동하는지 확인<br>
        <strong>현재 시간:</strong> <span id="currentTime"></span><br>
        <strong>테스트 이메일:</strong> test@example.com
    </div>

    <div class="warning">
        <strong>⚠️ 중요:</strong> 아래 버튼들을 클릭하면 실제로 메일 완료 처리가 실행됩니다.<br>
        자동 로그인이 성공하면 대시보드로 이동하고, 실패하면 로그인 페이지로 이동합니다.
    </div>
    
    <div class="test-section">
        <h3>🔗 1. GET 방식 일괄완료 테스트 (가장 일반적)</h3>
        <p>이메일에서 완료 버튼을 직접 클릭하는 방식과 동일합니다.</p>
        <a href="https://periodic-task-manager.vercel.app/api/tasks/batch-complete?tasks=test-task-1,test-task-2&completed_by=test@example.com" class="btn">
            GET 방식으로 완료 처리
        </a>
        <div class="log">
https://periodic-task-manager.vercel.app/api/tasks/batch-complete?tasks=test-task-1,test-task-2&completed_by=test@example.com
        </div>
    </div>
    
    <div class="test-section">
        <h3>📝 2. POST 방식 일괄완료 테스트</h3>
        <p>이메일 폼에서 완료 버튼을 클릭하는 방식과 동일합니다.</p>
        <form method="post" action="https://periodic-task-manager.vercel.app/api/tasks/batch-complete" style="margin: 10px 0;">
            <input type="hidden" name="completed_by" value="test@example.com" />
            <input type="hidden" name="task_ids" value="test-task-1" />
            <input type="hidden" name="task_ids" value="test-task-2" />
            <button type="submit" class="btn btn-batch">POST 방식으로 완료 처리</button>
        </form>
    </div>

    <div class="test-section">
        <h3>🔍 3. 실제 메일 발송 및 테스트</h3>
        <p>실제로 이메일을 발송하고 메일에서 완료 버튼을 테스트해보세요.</p>
        <a href="https://periodic-task-manager.vercel.app/api/email/send-daily" class="btn" target="_blank">
            📧 실제 메일 발송
        </a>
        <p><small>* 메일을 받은 후 메일에서 완료 버튼을 클릭해보세요.</small></p>
    </div>
    
    <div class="test-section">
        <h3>🛠️ 4. 디버깅 도구</h3>
        <a href="https://periodic-task-manager.vercel.app/api/test/cleanup-tokens" class="btn btn-tool" target="_blank">토큰 정리</a>
        <a href="https://periodic-task-manager.vercel.app/api/test/email-tokens-table" class="btn btn-tool" target="_blank">토큰 상태 확인</a>
        <a href="https://periodic-task-manager.vercel.app/dashboard" class="btn btn-tool" target="_blank">대시보드 직접 접속</a>
        <a href="https://vercel.com/dadae5th/periodic-task-manager/functions" class="btn btn-tool" target="_blank">Vercel 로그</a>
    </div>
    
    <div class="test-section">
        <h3>🎯 예상 동작 순서</h3>
        <ol>
            <li><strong>완료 버튼 클릭</strong> → batch-complete API 호출</li>
            <li><strong>업무 완료 처리</strong> → Mock 데이터로 처리</li>
            <li><strong>이메일 토큰 생성</strong> → email-token API 호출</li>
            <li><strong>자동 로그인</strong> → email-login API로 리디렉션</li>
            <li><strong>대시보드 표시</strong> → 쿠키 설정 후 대시보드 로딩</li>
        </ol>
        
        <h4>🚨 문제 발생시 체크포인트:</h4>
        <ul>
            <li>로그인 페이지로 이동하는 경우 → 토큰 생성 또는 검증 실패</li>
            <li>404 에러 → API 경로 문제</li>
            <li>500 에러 → 서버 내부 오류 (Vercel 로그 확인)</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>📊 현재 시스템 상태</h3>
        <p>시스템이 정상적으로 작동하려면 다음이 모두 성공해야 합니다:</p>
        <div id="systemStatus">
            <p>🔄 시스템 상태 확인 중...</p>
        </div>
    </div>

    <script>
        // 현재 시간 표시
        document.getElementById('currentTime').textContent = new Date().toLocaleString('ko-KR');
        
        // 시스템 상태 확인
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            const checks = [
                { name: 'batch-complete API', url: '/api/tasks/index' },
                { name: 'email-token API', url: '/api/auth/email-token' },
                { name: 'email-login API', url: '/api/auth/email-login' }
            ];
            
            let statusHtml = '';
            
            for (const check of checks) {
                try {
                    const response = await fetch(check.url, { method: 'HEAD' });
                    const status = response.status < 500 ? '✅' : '❌';
                    statusHtml += `<p>${status} ${check.name}: ${response.status}</p>`;
                } catch (error) {
                    statusHtml += `<p>❌ ${check.name}: 연결 실패</p>`;
                }
            }
            
            statusDiv.innerHTML = statusHtml;
        }
        
        // 페이지 로드시 상태 확인
        checkSystemStatus();
    </script>
</body>
</html>
